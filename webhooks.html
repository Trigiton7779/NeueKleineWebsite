<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Tests - n8n Integration</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="js/config-loader.js" defer></script>
    <script src="js/components.js" defer></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-gray-900 to-gray-950 text-white relative">
    <!-- Animated Background -->
    <div class="absolute inset-0 pointer-events-none">
        <!-- Circuit Pattern Background -->
        <div class="absolute inset-0 opacity-10" style="background-image: url('assets/images/circuit-pattern.webp'); background-size: cover; background-position: center; background-repeat: no-repeat;"></div>
        <div class="absolute top-20 left-20 w-3 h-3 bg-blue-400/40 rounded-full animate-ping" style="animation-delay: 0s; animation-duration: 3s;"></div>
        <div class="absolute top-40 right-32 w-2 h-2 bg-green-400/50 rounded-full animate-ping" style="animation-delay: 1s; animation-duration: 4s;"></div>
        <div class="absolute bottom-40 left-32 w-2.5 h-2.5 bg-purple-400/45 rounded-full animate-ping" style="animation-delay: 2s; animation-duration: 3.5s;"></div>
        <div class="absolute bottom-20 right-20 w-2 h-2 bg-blue-300/35 rounded-full animate-ping" style="animation-delay: 3s; animation-duration: 4.5s;"></div>
        <div class="absolute top-60 left-1/2 w-1.5 h-1.5 bg-green-300/40 rounded-full animate-ping" style="animation-delay: 1.5s; animation-duration: 3.2s;"></div>
        <div class="absolute bottom-60 right-1/3 w-3 h-3 bg-purple-300/35 rounded-full animate-ping" style="animation-delay: 2.5s; animation-duration: 4.2s;"></div>
        <div class="absolute top-32 right-1/4 w-1.5 h-1.5 bg-blue-200/30 rounded-full animate-ping" style="animation-delay: 4s; animation-duration: 3.8s;"></div>
        <div class="absolute bottom-32 left-1/4 w-2 h-2 bg-green-200/35 rounded-full animate-ping" style="animation-delay: 0.5s; animation-duration: 3.6s;"></div>
        <div class="absolute top-1/2 right-12 w-1 h-1 bg-purple-200/40 rounded-full animate-ping" style="animation-delay: 3.5s; animation-duration: 4.8s;"></div>
        <div class="absolute top-3/4 left-12 w-2.5 h-2.5 bg-cyan-400/30 rounded-full animate-ping" style="animation-delay: 1.8s; animation-duration: 3.4s;"></div>
        <div class="absolute top-1/4 left-3/4 w-2 h-2 bg-pink-400/35 rounded-full animate-ping" style="animation-delay: 2.2s; animation-duration: 3.7s;"></div>
        <div class="absolute bottom-1/4 right-3/4 w-1.5 h-1.5 bg-indigo-400/40 rounded-full animate-ping" style="animation-delay: 1.2s; animation-duration: 4.1s;"></div>
    </div>

    <!-- Navigation -->
    <nav class="p-6 relative z-10">
        <a href="index.html" class="text-blue-400 hover:text-blue-300 transition-colors">← Zurück zur Startseite</a>
    </nav>

    <div class="container mx-auto px-6 py-8 relative z-10">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-green-400 bg-clip-text text-transparent mb-4">
                    n8n Webhook Tests
                </h1>
                <p class="text-gray-300 text-lg">Testen Sie Ihre n8n Webhook-Integrationen</p>
            </div>

            <!-- Webhook Configuration -->
            <div class="bg-gray-800 rounded-lg p-6 mb-8 border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-green-400">Webhook Konfiguration</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">n8n Webhook URL</label>
                        <input type="url" id="webhookUrl" placeholder="https://your-n8n-instance.com/webhook/your-webhook-id" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">HTTP Method</label>
                        <select id="httpMethod" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="POST">POST</option>
                            <option value="GET">GET</option>
                            <option value="PUT">PUT</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Quick Test Forms -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <!-- Simple Test -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 text-blue-400">Einfacher Test</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Test Nachricht</label>
                            <input type="text" id="simpleMessage" value="Hallo von der Website!" 
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button onclick="sendSimpleTest()" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                            Test senden
                        </button>
                    </div>
                </div>

                <!-- Form Data Test -->
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 text-purple-400">Formular Test</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Name</label>
                            <input type="text" id="formName" placeholder="Ihr Name" 
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                            <input type="email" id="formEmail" placeholder="ihre@email.de" 
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <button onclick="sendFormTest()" 
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                            Formular senden
                        </button>
                    </div>
                </div>
            </div>

            <!-- Custom JSON Test -->
            <div class="bg-gray-800 rounded-lg p-6 mb-8 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4 text-green-400">Custom JSON Test</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">JSON Payload</label>
                        <textarea id="jsonPayload" rows="6" 
                                  class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                                  placeholder='{"key": "value", "timestamp": "2023-01-01T00:00:00Z"}'>{
  "test": true,
  "message": "Custom webhook test",
  "timestamp": new Date().toISOString(),
  "source": "website"
}</textarea>
                    </div>
                    <button onclick="sendJsonTest()" 
                            class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                        JSON senden
                    </button>
                </div>
            </div>

            <!-- File Upload Test -->
            <div class="bg-gray-800 rounded-lg p-6 mb-8 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4 text-orange-400">PDF Upload & Verarbeitung</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">PDF-Datei auswählen</label>
                        <div class="relative">
                            <input type="file" id="fileInput" accept=".pdf" 
                                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                   onchange="handleFileSelection()">
                            <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-orange-400 transition-colors">
                                <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="text-gray-300 mb-1">PDF-Datei hier ablegen oder</p>
                                <p class="text-orange-400 font-medium">Klicken zum Auswählen</p>
                                <p class="text-xs text-gray-500 mt-2">Nur PDF-Dateien erlaubt</p>
                            </div>
                        </div>
                        <div id="fileInfo" class="mt-2 text-sm text-gray-400 hidden">
                            <span id="fileName"></span> (<span id="fileSize"></span>)
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Zusätzliche Parameter (optional)</label>
                        <textarea id="fileParams" rows="3" 
                                  class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
                                  placeholder='{"processing_type": "extract_text", "language": "de"}'></textarea>
                    </div>
                    
                    <button onclick="sendFileTest()" id="uploadBtn" disabled
                            class="w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium py-2 px-4 rounded-md transition-colors">
                        PDF hochladen & verarbeiten
                    </button>
                </div>
            </div>

            <!-- Response Area -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4 text-yellow-400">Response Log</h3>
                <div id="responseLog" class="bg-gray-900 rounded p-4 min-h-32 font-mono text-sm text-gray-300 overflow-auto">
                    Hier werden die Webhook-Antworten angezeigt...
                </div>
                <button onclick="clearLog()" 
                        class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-medium py-1 px-3 rounded text-sm transition-colors">
                    Log löschen
                </button>
            </div>
        </div>
    </div>

    <script>
        function getWebhookUrl() {
            const url = document.getElementById('webhookUrl').value;
            if (!url) {
                logResponse('❌ Bitte n8n Webhook URL eingeben');
                return null;
            }
            return url;
        }

        function getHttpMethod() {
            return document.getElementById('httpMethod').value;
        }

        function logResponse(message) {
            const log = document.getElementById('responseLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        async function sendWebhook(data, contentType = 'application/json') {
            const url = getWebhookUrl();
            if (!url) return;

            const method = getHttpMethod();
            
            try {
                logResponse(`📤 Sende ${method} Request an ${url}`);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': contentType
                    }
                };

                if (method !== 'GET' && data) {
                    options.body = typeof data === 'string' ? data : JSON.stringify(data);
                }

                const response = await fetch(url, options);
                const responseText = await response.text();
                
                logResponse(`✅ Status: ${response.status} ${response.statusText}`);
                logResponse(`📥 Response: ${responseText || 'Keine Antwort'}`);
                
            } catch (error) {
                logResponse(`❌ Fehler: ${error.message}`);
            }
        }

        function sendSimpleTest() {
            const message = document.getElementById('simpleMessage').value;
            sendWebhook({ message: message, type: 'simple_test' });
        }

        function sendFormTest() {
            const name = document.getElementById('formName').value;
            const email = document.getElementById('formEmail').value;
            
            if (!name || !email) {
                logResponse('❌ Bitte alle Formularfelder ausfüllen');
                return;
            }
            
            sendWebhook({
                name: name,
                email: email,
                type: 'form_test',
                timestamp: new Date().toISOString()
            });
        }

        function sendJsonTest() {
            const jsonText = document.getElementById('jsonPayload').value;
            
            try {
                const jsonData = JSON.parse(jsonText);
                sendWebhook(jsonData);
            } catch (error) {
                logResponse(`❌ Ungültiges JSON: ${error.message}`);
            }
        }

        function clearLog() {
            document.getElementById('responseLog').innerHTML = 'Log gelöscht...\n';
        }

        // File handling functions
        function handleFileSelection() {
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const uploadBtn = document.getElementById('uploadBtn');

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.classList.remove('hidden');
                uploadBtn.disabled = false;
                
                logResponse(`📁 Datei ausgewählt: ${file.name} (${formatFileSize(file.size)})`);
            } else {
                fileInfo.classList.add('hidden');
                uploadBtn.disabled = true;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function sendFileTest() {
            const url = getWebhookUrl();
            if (!url) return;

            const fileInput = document.getElementById('fileInput');
            const fileParams = document.getElementById('fileParams').value;

            if (!fileInput.files.length) {
                logResponse('❌ Bitte eine PDF-Datei auswählen');
                return;
            }

            const file = fileInput.files[0];
            
            // Check file type
            if (file.type !== 'application/pdf') {
                logResponse('❌ Nur PDF-Dateien sind erlaubt');
                return;
            }

            try {
                logResponse(`📤 Lade ${file.name} hoch...`);
                
                const formData = new FormData();
                formData.append('file', file);
                
                // Add additional parameters if provided
                if (fileParams.trim()) {
                    try {
                        const params = JSON.parse(fileParams);
                        Object.keys(params).forEach(key => {
                            formData.append(key, params[key]);
                        });
                    } catch (error) {
                        logResponse(`⚠️ Ungültige Parameter (ignoriert): ${error.message}`);
                    }
                }

                const method = getHttpMethod();
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                logResponse(`✅ Upload Status: ${response.status} ${response.statusText}`);
                
                // Check if response is a file
                const contentType = response.headers.get('content-type');
                const contentDisposition = response.headers.get('content-disposition');
                
                if (contentDisposition && contentDisposition.includes('attachment')) {
                    // Response is a file - download it
                    const blob = await response.blob();
                    const filename = extractFilename(contentDisposition) || 'download';
                    downloadFile(blob, filename);
                    logResponse(`📥 Datei erhalten: ${filename}`);
                } else {
                    // Response is text/json
                    const responseText = await response.text();
                    logResponse(`📥 Response: ${responseText || 'Keine Antwort'}`);
                    
                    // Try to parse as JSON and check for file data
                    try {
                        const jsonResponse = JSON.parse(responseText);
                        if (jsonResponse.file_data && jsonResponse.filename) {
                            // Base64 encoded file response
                            const binaryString = atob(jsonResponse.file_data);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            const blob = new Blob([bytes]);
                            downloadFile(blob, jsonResponse.filename);
                            logResponse(`📥 Datei aus JSON extrahiert: ${jsonResponse.filename}`);
                        }
                    } catch (e) {
                        // Not JSON or no file data, response already logged
                    }
                }
                
            } catch (error) {
                logResponse(`❌ Upload-Fehler: ${error.message}`);
            }
        }

        function extractFilename(contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
            return filenameMatch ? filenameMatch[1].replace(/['"]/g, '') : null;
        }

        function downloadFile(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const defaultJson = {
                "test": true,
                "message": "Custom webhook test",
                "timestamp": new Date().toISOString(),
                "source": "website"
            };
            document.getElementById('jsonPayload').value = JSON.stringify(defaultJson, null, 2);

            // Add drag and drop to file input area
            const dropArea = document.querySelector('#fileInput').parentElement;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.querySelector('div').classList.add('border-orange-400');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.querySelector('div').classList.remove('border-orange-400');
                }, false);
            });

            dropArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('fileInput').files = files;
                    handleFileSelection();
                }
            }, false);
        });
    </script>

    <div id="footer-placeholder"></div>
</body>
</html>
